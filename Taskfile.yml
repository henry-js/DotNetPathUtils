# https://taskfile.dev
version: "3"

dotenv: ["public.env", ".env"]

vars:
  # These variables are now expected to be passed in from the CI/CD workflow.
  APP_VERSION: "{{.APP_VERSION}}"
  GITHUB_REF_NAME: "{{.GITHUB_REF_NAME}}"
  # This remains for local use if needed.
  MAIN_EXE: "{{if .PROJECT_TO_PUBLISH}}{{.APP_NAME}}.exe{{end}}"

includes:
  dotnet:
    taskfile: ./.build/dotnet/Taskfile.yml
  velopack:
    taskfile: ./.build/velopack/Taskfile.yml
    optional: true

tasks:
  default:
    cmds: [{ task: build }]

  # --- Core DotNet Tasks ---
  clean:
    cmds: [{ task: dotnet:clean }]
  build:
    cmds: [{ task: dotnet:build }]
  test:
    cmds: [{ task: dotnet:test }]
  setup:
    desc: "Restores local .NET tools defined in the manifest"
    preconditions:
      - "[ -f .config/dotnet-tools.json ]"
    cmds: ["dotnet tool restore"]
  get-version:
    desc: "Calculates the version from git history (for pre-release builds)"
    deps: ["setup"]
    cmds: ["dotnet minver --default-pre-release-identifiers preview.0 -v error"]

  # --- Release Entrypoint (Called by CI) ---
  release:
    desc: "Publishes NuGet and/or Velopack releases based on configuration."
    cmds:
      - task: push-nuget
      - task: release-velopack

  # --- NuGet Publishing Logic ---
  pack-nuget:
    desc: "Packs the project as a NuGet package"
    preconditions:
      - '{{ ne .PROJECT_TO_PACK "" }}'
      - msg: "Skipping NuGet pack: PROJECT_TO_PACK is not set."
    cmds: [{ task: dotnet:pack-nuget }]
  push-nuget:
    desc: "Packs and pushes the library to a NuGet feed"
    # This task now has ALL the preconditions. If PROJECT_TO_PACK is not set,
    # it won't even try to pack.
    deps: ["pack-nuget"]
    preconditions:
      - '{{ ne .NUGET_API_KEY "" }}'
      - msg: "NUGET_API_KEY is not set. Cannot push."
    cmds: [{ task: dotnet:push-nuget }]

  # --- Velopack Publishing Logic ---
  publish-app:
    desc: "Publishes the main executable project files"
    preconditions:
      - '{{ ne .PROJECT_TO_PUBLISH "" }}'
      - msg: "Skipping app publish: PROJECT_TO_PUBLISH is not set."
    cmds: [{ task: dotnet:publish-app }]
  setup-velopack:
    desc: "Installs the Velopack CLI tool, if not already present"
    cmds: ["dotnet tool install --global vpk"]
    status: ["vpk --version"] # This prevents reinstalling if it's already there.
  release-velopack:
    desc: "Packs and uploads a Velopack release"
    deps: ["setup-velopack", "publish-app"]
    cmds:
      - task: velopack:pack
        vars:
          APP_VERSION: "{{.APP_VERSION}}" # Passes version from root
      - task: upload:assets
  upload-assets:
    desc: "Uploads release assets to GitHub"
    cmds: ["gh release upload {{.GITHUB_REF_NAME}} ./dist/releases/*"]
